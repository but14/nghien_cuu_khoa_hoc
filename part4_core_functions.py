    def toggle_detection(self):
        if self.detection_enabled.get():
            if not (self.torch_available or self.ultralytics_available):
                self.detection_enabled.set(False)
                messagebox.showerror("L·ªói", "Thi·∫øu th∆∞ vi·ªán ƒë·ªÉ b·∫≠t nh·∫≠n di·ªán h√†nh vi: pip install torch ultralytics")
                return
            if self.model is None and not self.load_model():
                self.detection_enabled.set(False)
                return
            messagebox.showinfo("Th√¥ng b√°o", "ƒê√£ b·∫≠t nh·∫≠n di·ªán h√†nh vi.")
        else:
            messagebox.showinfo("Th√¥ng b√°o", "ƒê√£ t·∫Øt nh·∫≠n di·ªán h√†nh vi.")

    def toggle_student_detection(self):
        if self.student_detection_enabled.get():
            if not self.torch_available:
                self.student_detection_enabled.set(False)
                messagebox.showerror("L·ªói", "Thi·∫øu torch: pip install torch")
                return
            if self.student_model is None and not self.load_student_model():
                self.student_detection_enabled.set(False)
                return
            messagebox.showinfo("Th√¥ng b√°o", "ƒê√£ b·∫≠t nh·∫≠n di·ªán h·ªçc sinh.")
        else:
            self.current_student = None
            messagebox.showinfo("Th√¥ng b√°o", "ƒê√£ t·∫Øt nh·∫≠n di·ªán h·ªçc sinh.")

    def start_counting(self):
        if not (self.cap and getattr(self.cap, "isOpened", lambda: False)()):
            messagebox.showerror("L·ªói", "Ch∆∞a c√≥ camera n√†o ƒëang m·ªü.")
            return
        if not self.detection_enabled.get():
            messagebox.showerror("L·ªói", "Vui l√≤ng b·∫≠t ch·∫ø ƒë·ªô nh·∫≠n di·ªán h√†nh vi tr∆∞·ªõc khi ƒë·∫øm.")
            return
        if self.counting:
            messagebox.showinfo("Th√¥ng b√°o", "ƒê√£ ƒëang ƒë·∫øm.")
            return

        # Reset counters
        self.behavior_counts = Counter()
        self.student_behavior_counts = defaultdict(Counter)
        self.current_behaviors = {}
        self.last_detected = None
        self.last_detected_time = 0.0

        self.counting = True
        self.start_time = time.time()
        self.recorded_time = 0
        if self.student_detection_enabled.get():
            status = f"üî¥ ƒêang ƒë·∫øm h√†nh vi theo h·ªçc sinh (camera {self.current_cam_index})..."
            if self.current_student:
                self.count_label.config(text=f"ƒêang ƒë·∫øm h√†nh vi cho h·ªçc sinh: {self.current_student}...\nCh∆∞a ph√°t hi·ªán h√†nh vi n√†o.")
            else:
                self.count_label.config(text="ƒêang ƒë·∫øm h√†nh vi...\nƒêang ƒë·ª£i nh·∫≠n di·ªán h·ªçc sinh.")
            messagebox.showinfo("Th√¥ng b√°o", "B·∫Øt ƒë·∫ßu ƒë·∫øm h√†nh vi theo h·ªçc sinh!")
        else:
            status = f"üî¥ ƒêang ƒë·∫øm h√†nh vi (camera {self.current_cam_index})..."
            self.count_label.config(text="ƒêang ƒë·∫øm h√†nh vi...\nCh∆∞a ph√°t hi·ªán h√†nh vi n√†o.")
            messagebox.showinfo("Th√¥ng b√°o", "B·∫Øt ƒë·∫ßu ƒë·∫øm h√†nh vi!")

        self.info_label.config(text=status)

    def stop_counting(self):
        if not self.counting:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a b·∫Øt ƒë·∫ßu ƒë·∫øm h√†nh vi.")
            return
        self.counting = False
        self.recorded_time = int(time.time() - self.start_time) if self.start_time else 0
        status = f"üü° ƒê√£ d·ª´ng ƒë·∫øm. Th·ªùi gian: {self.recorded_time} gi√¢y (camera {self.current_cam_index})"
        self.info_label.config(text=status)
        self.show_behavior_report()
        self.save_behavior_report()

    def update_count_display(self):
        """C·∫≠p nh·∫≠t label b√™n UI hi·ªÉn th·ªã k·∫øt qu·∫£ ƒë·∫øm hi·ªán t·∫°i."""
        if not self.counting:
            return
        if self.current_student:
            lines = [f"H·ªçc sinh hi·ªán t·∫°i: {self.current_student}", "", "S·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa c√°c h√†nh vi:"]
            beh = self.student_behavior_counts.get(self.current_student, {})
            if beh:
                for b, c in sorted(beh.items()):
                    lines.append(f"- {b}: {c} l·∫ßn")
            else:
                lines.append("Ch∆∞a ph√°t hi·ªán h√†nh vi n√†o.")
            cur = self.current_behaviors.get(self.current_student)
            if cur:
                lines.append("")
                lines.append(f"H√†nh vi hi·ªán t·∫°i: {cur}")
        else:
            lines = ["S·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa c√°c h√†nh vi:"]
            if self.behavior_counts:
                for b, c in sorted(self.behavior_counts.items()):
                    lines.append(f"- {b}: {c} l·∫ßn")
            else:
                lines.append("Ch∆∞a ph√°t hi·ªán h√†nh vi n√†o.")
            if self.student_detection_enabled.get():
                lines.append("")
                lines.append("(ƒêang ƒë·ª£i nh·∫≠n di·ªán h·ªçc sinh...)")
        self.count_label.config(text="\n".join(lines))

    def save_behavior_report(self):
        """L∆∞u b√°o c√°o text v√†o th∆∞ m·ª•c reports."""
        os.makedirs("reports", exist_ok=True)
        fname = time.strftime("reports/behavior_report_%Y%m%d_%H%M%S.txt")
        try:
            with open(fname, "w", encoding="utf-8") as f:
                f.write(f"B√ÅO C√ÅO H√ÄNH VI - {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"Th·ªùi gian ƒë·∫øm: {self.recorded_time} gi√¢y\n")
                f.write(f"Camera: {self.current_cam_index}\n\n")
                if self.student_detection_enabled.get() and self.student_behavior_counts:
                    f.write("B√ÅO C√ÅO THEO H·ªåC SINH:\n=====================\n\n")
                    for student, behaviors in sorted(self.student_behavior_counts.items()):
                        f.write(f"H·ªçc sinh: {student}\n")
                        if behaviors:
                            for b, c in sorted(behaviors.items()):
                                f.write(f"  - {b}: {c} l·∫ßn\n")
                        else:
                            f.write("  Kh√¥ng ph√°t hi·ªán h√†nh vi n√†o.\n")
                        f.write("\n")
                    f.write("\nT·ªîNG H·ª¢P T·∫§T C·∫¢ H√ÄNH VI:\n=====================\n\n")
                f.write("S·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa c√°c h√†nh vi:\n")
                if self.behavior_counts:
                    for b, c in sorted(self.behavior_counts.items()):
                        f.write(f"- {b}: {c} l·∫ßn\n")
                else:
                    f.write("Kh√¥ng ph√°t hi·ªán h√†nh vi n√†o trong th·ªùi gian ƒë·∫øm.\n")
            messagebox.showinfo("Th√¥ng b√°o", f"ƒê√£ l∆∞u b√°o c√°o v√†o file: {fname}")
        except Exception as e:
            LOG.exception("L·ªói save_behavior_report: %s", e)
            messagebox.showerror("L·ªói", f"Kh√¥ng l∆∞u ƒë∆∞·ª£c b√°o c√°o: {e}")

    def show_behavior_report(self):
        """Hi·ªÉn th·ªã b√°o c√°o chi ti·∫øt trong m·ªôt c·ª≠a s·ªï m·ªõi."""
        report_window = tk.Toplevel(self.root)
        report_window.title("üìä B√°o c√°o h√†nh vi")
        report_window.geometry("700x700")
        report_window.configure(bg="#f2e9e4")

        text_frame = tk.Frame(report_window, bg="#f2e9e4")
        text_frame.pack(fill="both", expand=True, padx=20, pady=20)

        scrollbar = tk.Scrollbar(text_frame)
        scrollbar.pack(side="right", fill="y")

        text_widget = tk.Text(text_frame, wrap="word", font=("Arial", 12), bg="#ffffff")
        text_widget.pack(side="left", fill="both", expand=True)
        scrollbar.config(command=text_widget.yview)
        text_widget.config(yscrollcommand=scrollbar.set)

        report = []
        report.append("B√ÅO C√ÅO H√ÄNH VI\n")
        if hasattr(self, "recorded_time") and self.recorded_time:
            report.append(f"Th·ªùi gian ƒë·∫øm: {self.recorded_time} gi√¢y\n")

        if self.student_detection_enabled.get() and self.student_behavior_counts:
            report.append("\nB√ÅO C√ÅO THEO H·ªåC SINH:\n=====================\n")
            for student, behaviors in sorted(self.student_behavior_counts.items()):
                report.append(f"H·ªçc sinh: {student}\n")
                if behaviors:
                    for b, c in sorted(behaviors.items()):
                        report.append(f"  - {b}: {c} l·∫ßn\n")
                else:
                    report.append("  Kh√¥ng ph√°t hi·ªán h√†nh vi n√†o.\n")
                report.append("\n")
            report.append("\nT·ªîNG H·ª¢P T·∫§T C·∫¢ H√ÄNH VI:\n=====================\n")

        report.append("\nS·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa c√°c h√†nh vi:\n")
        if self.behavior_counts:
            for b, c in sorted(self.behavior_counts.items()):
                report.append(f"- {b}: {c} l·∫ßn\n")
        else:
            report.append("Kh√¥ng ph√°t hi·ªán h√†nh vi n√†o trong th·ªùi gian ƒë·∫øm.")

        text_widget.insert("1.0", "".join(report))
        text_widget.config(state="disabled")

        # Save & Export buttons
        save_btn = tk.Button(report_window, text="L∆∞u b√°o c√°o", command=self.save_behavior_report,
                             bg="#ffffff", activebackground="#fde2e4", relief="raised", bd=2, font=("Arial", 12, "bold"), cursor="hand2")
        save_btn.pack(pady=6)

        # Excel export if pandas available
        try:
            import pandas as pd  # noqa: F401
            excel_btn = tk.Button(report_window, text="Xu·∫•t Excel", command=self.export_excel_report,
                                  bg="#ffffff", activebackground="#d0f0c0", relief="raised", bd=2, font=("Arial", 12, "bold"), cursor="hand2")
            excel_btn.pack(pady=6)
        except Exception:
            pass

    def export_excel_report(self):
        """Xu·∫•t b√°o c√°o sang Excel n·∫øu pandas c√≥ s·∫µn."""
        try:
            import pandas as pd
            os.makedirs("reports", exist_ok=True)
            excel_file = time.strftime("reports/behavior_report_%Y%m%d_%H%M%S.xlsx")

            summary_data = [{"H√†nh vi": b, "S·ªë l·∫ßn xu·∫•t hi·ªán": c} for b, c in sorted(self.behavior_counts.items())]
            summary_df = pd.DataFrame(summary_data)

            student_data = []
            for student, behaviors in sorted(self.student_behavior_counts.items()):
                for b, c in sorted(behaviors.items()):
                    student_data.append({"H·ªçc sinh": student, "H√†nh vi": b, "S·ªë l·∫ßn xu·∫•t hi·ªán": c})
            student_df = pd.DataFrame(student_data)

            with pd.ExcelWriter(excel_file) as writer:
                summary_df.to_excel(writer, sheet_name="T·ªïng h·ª£p", index=False)
                if not student_df.empty:
                    student_df.to_excel(writer, sheet_name="Theo h·ªçc sinh", index=False)

            messagebox.showinfo("Th√¥ng b√°o", f"ƒê√£ xu·∫•t b√°o c√°o Excel: {excel_file}")
        except ImportError:
            messagebox.showerror("L·ªói", "C·∫ßn c√†i ƒë·∫∑t pandas ƒë·ªÉ xu·∫•t Excel:\n pip install pandas openpyxl")
        except Exception as e:
            LOG.exception("L·ªói export_excel_report: %s", e)
            messagebox.showerror("L·ªói", f"Kh√¥ng th·ªÉ xu·∫•t Excel: {e}")

    def update_camera(self):
        """H√†m ƒë∆∞·ª£c g·ªçi ƒë·ªãnh k·ª≥ ƒë·ªÉ ƒë·ªçc frame t·ª´ camera v√† hi·ªÉn th·ªã."""
        try:
            if self.cap and getattr(self.cap, "isOpened", lambda: False)() and self.main_frame.winfo_ismapped():
                ret, frame = self.cap.read()
                if ret and frame is not None:
                    h0, w0 = frame.shape[:2]
                    vw = max(320, self.video_label.winfo_width())
                    vh = max(240, self.video_label.winfo_height())
                    scale = min(vw / w0, vh / h0) if w0 and h0 else 1.0
                    new_w = max(320, int(w0 * scale))
                    new_h = max(240, int(h0 * scale))

                    resized_bgr = cv2.resize(frame, (new_w, new_h), interpolation=cv2.INTER_AREA)

                    # Student detection (throttled)
                    now = time.time()
                    if self.student_detection_enabled.get() and self.student_model is not None and (now - self.last_student_time > self.student_cooldown):
                        try:
                            student = self.detect_student(resized_bgr)
                            if student:
                                # ensure entry exists
                                if student not in self.student_behavior_counts:
                                    self.student_behavior_counts[student] = Counter()
                        except Exception:
                            LOG.exception("L·ªói khi detect_student trong loop")

                    # Object detection & counting
                    try:
                        annotated = self.detect_objects_and_count(resized_bgr)
                    except Exception:
                        LOG.exception("L·ªói detect_objects_and_count")
                        annotated = resized_bgr

                    # Convert BGR->RGB for Tk display
                    frame_rgb = cv2.cvtColor(annotated, cv2.COLOR_BGR2RGB)
                    imgtk = ImageTk.PhotoImage(Image.fromarray(frame_rgb))
                    self.video_label.imgtk = imgtk
                    self.video_label.configure(image=imgtk)
                    self.frame_size = (new_w, new_h)

                    # update status label
                    status = f"üü¢ Camera {self.current_cam_index} ƒëang b·∫≠t"
                    if self.counting:
                        status += " (ƒêang ƒë·∫øm h√†nh vi...)"
                    else:
                        parts = []
                        if self.student_detection_enabled.get():
                            parts.append("Nh·∫≠n di·ªán h·ªçc sinh: B·∫¨T")
                        if self.detection_enabled.get():
                            parts.append("Nh·∫≠n di·ªán h√†nh vi: B·∫¨T")
                        status += f" ({', '.join(parts)})" if parts else " ‚Äì s·∫µn s√†ng ƒë·∫øm h√†nh vi."
                    self.info_label.config(text=status)
                else:
                    self.video_label.configure(image="")
        except Exception:
            LOG.exception("L·ªói update_camera")
        finally:
            # call again after ~30 ms (~33 fps)
            self.root.after(30, self.update_camera)

    def on_close(self):
        if self.counting:
            if not messagebox.askyesno("ƒêang ƒë·∫øm", "ƒêang ƒë·∫øm h√†nh vi. Mu·ªën d·ª´ng v√† tho√°t?"):
                return
            self.stop_counting()
        try:
            if self.cap and getattr(self.cap, "isOpened", lambda: False)():
                self.cap.release()
        except Exception:
            pass
        self.root.destroy()

    def __del__(self):
        try:
            if self.cap and getattr(self.cap, "isOpened", lambda: False)():
                self.cap.release()
        except Exception:
            pass